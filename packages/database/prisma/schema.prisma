// Prisma Schema for SSOO
// 참조: docs/database/rules.md
// PostgreSQL 멀티스키마: common (cm_), pms (pr_), dms (dm_)

generator client {
  provider = "prisma-client-js"
}

generator dbml {
  provider = "prisma-dbml-generator"
  output   = "../dbml"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["common", "pms", "dms"]
}

// ============================================
// Common Code (공통 코드) - cm_code_m
// ============================================
model CmCode {
  id              BigInt   @id @default(autoincrement()) @map("code_id")
  
  codeGroup       String   @map("code_group")
  codeValue       String   @map("code_value")
  parentCode      String?  @map("parent_code")
  
  displayNameKo   String   @map("display_name_ko")
  displayNameEn   String?  @map("display_name_en")
  description     String?
  sortOrder       Int      @default(0) @map("sort_order")

  // Common columns
  isActive        Boolean  @default(true) @map("is_active")
  memo            String?
  createdBy       BigInt?  @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedBy       BigInt?  @map("updated_by")
  updatedAt       DateTime @updatedAt @map("updated_at")
  lastSource      String?  @map("last_source")
  lastActivity    String?  @map("last_activity")
  transactionId   String?  @map("transaction_id") @db.Uuid

  @@unique([codeGroup, codeValue], name: "ux_cm_code_m_group_value")
  @@index([codeGroup], name: "ix_cm_code_m_group")
  @@index([isActive], name: "ix_cm_code_m_active")
  @@map("cm_code_m")
  @@schema("pms")
}

// ============================================
// Common Code History - cm_code_h
// ============================================
model CmCodeHistory {
  codeId          BigInt   @map("code_id")
  historySeq      BigInt   @map("history_seq")
  
  eventType       String   @map("event_type") @db.Char(1) // C, U, D
  eventAt         DateTime @map("event_at")

  codeGroup       String   @map("code_group")
  codeValue       String   @map("code_value")
  parentCode      String?  @map("parent_code")
  displayNameKo   String   @map("display_name_ko")
  displayNameEn   String?  @map("display_name_en")
  description     String?
  sortOrder       Int      @map("sort_order")

  isActive        Boolean  @map("is_active")
  memo            String?
  createdBy       BigInt?  @map("created_by")
  createdAt       DateTime @map("created_at")
  updatedBy       BigInt?  @map("updated_by")
  updatedAt       DateTime @map("updated_at")
  lastSource      String?  @map("last_source")
  lastActivity    String?  @map("last_activity")
  transactionId   String?  @map("transaction_id") @db.Uuid

  @@id([codeId, historySeq], name: "pk_cm_code_h")
  @@index([eventAt], name: "ix_cm_code_h_event_at")
  @@index([transactionId], name: "ix_cm_code_h_tx")
  @@map("cm_code_h")
  @@schema("pms")
}

// ============================================
// Menu (메뉴) - cm_menu_m
// 시스템 메뉴 정의, 트리 구조
// ============================================
model Menu {
  id              BigInt   @id @default(autoincrement()) @map("menu_id")
  
  menuCode        String   @unique @map("menu_code") // 메뉴 고유 코드: dashboard, project.list
  menuName        String   @map("menu_name") // 표시명 (한글)
  menuNameEn      String?  @map("menu_name_en") // 표시명 (영문)
  menuType        String   @default("menu") @map("menu_type") // group, menu, action
  
  parentMenuId    BigInt?  @map("parent_menu_id") // 부모 메뉴 ID
  menuPath        String?  @map("menu_path") // 라우트 경로: /project, /project/[id]
  icon            String?  // 아이콘 이름 (lucide-react)
  sortOrder       Int      @default(0) @map("sort_order") // 정렬 순서
  menuLevel       Int      @default(1) @map("menu_level") // 메뉴 깊이 (1=최상위)
  
  isVisible       Boolean  @default(true) @map("is_visible") // 사이드바 표시 여부
  isEnabled       Boolean  @default(true) @map("is_enabled") // 활성화 여부
  isAdminMenu     Boolean  @default(false) @map("is_admin_menu") // 관리자 전용 메뉴 여부
  openType        String   @default("tab") @map("open_type") // tab, modal, external
  description     String?
  
  // Common columns
  isActive        Boolean  @default(true) @map("is_active")
  memo            String?
  createdBy       BigInt?  @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedBy       BigInt?  @map("updated_by")
  updatedAt       DateTime @updatedAt @map("updated_at")
  lastSource      String?  @map("last_source")
  lastActivity    String?  @map("last_activity")
  transactionId   String?  @map("transaction_id") @db.Uuid

  // Self-relation
  parentMenu      Menu?    @relation("MenuHierarchy", fields: [parentMenuId], references: [id], onDelete: SetNull)
  childMenus      Menu[]   @relation("MenuHierarchy")
  
  // Relations
  roleMenus       RoleMenu[]
  userMenus       UserMenu[]
  userFavorites   UserFavorite[]

  @@index([parentMenuId], name: "ix_cm_menu_m_parent")
  @@index([menuLevel, sortOrder], name: "ix_cm_menu_m_level_order")
  @@index([isActive], name: "ix_cm_menu_m_active")
  @@map("cm_menu_m")
  @@schema("pms")
}

// ============================================
// Menu History - cm_menu_h
// ============================================
model MenuHistory {
  menuId          BigInt   @map("menu_id")
  historySeq      BigInt   @map("history_seq")
  
  eventType       String   @map("event_type") @db.Char(1) // C, U, D
  eventAt         DateTime @map("event_at")

  menuCode        String   @map("menu_code")
  menuName        String   @map("menu_name")
  menuNameEn      String?  @map("menu_name_en")
  menuType        String   @map("menu_type")
  parentMenuId    BigInt?  @map("parent_menu_id")
  menuPath        String?  @map("menu_path")
  icon            String?
  sortOrder       Int      @map("sort_order")
  menuLevel       Int      @map("menu_level")
  isVisible       Boolean  @map("is_visible")
  isEnabled       Boolean  @map("is_enabled")
  isAdminMenu     Boolean  @default(false) @map("is_admin_menu")
  openType        String   @map("open_type")
  description     String?

  isActive        Boolean  @map("is_active")
  memo            String?
  createdBy       BigInt?  @map("created_by")
  createdAt       DateTime @map("created_at")
  updatedBy       BigInt?  @map("updated_by")
  updatedAt       DateTime @map("updated_at")
  lastSource      String?  @map("last_source")
  lastActivity    String?  @map("last_activity")
  transactionId   String?  @map("transaction_id") @db.Uuid

  @@id([menuId, historySeq], name: "pk_cm_menu_h")
  @@index([eventAt], name: "ix_cm_menu_h_event_at")
  @@index([transactionId], name: "ix_cm_menu_h_tx")
  @@map("cm_menu_h")
  @@schema("pms")
}

// ============================================
// Role Menu (역할별 메뉴 권한) - cm_role_menu_r
// ============================================
model RoleMenu {
  id              BigInt   @id @default(autoincrement()) @map("role_menu_id")
  
  roleCode        String   @map("role_code") // admin, manager, user, viewer
  menuId          BigInt   @map("menu_id")
  accessType      String   @default("full") @map("access_type") // full, read, none
  
  // Common columns
  isActive        Boolean  @default(true) @map("is_active")
  memo            String?
  createdBy       BigInt?  @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedBy       BigInt?  @map("updated_by")
  updatedAt       DateTime @updatedAt @map("updated_at")
  lastSource      String?  @map("last_source")
  lastActivity    String?  @map("last_activity")
  transactionId   String?  @map("transaction_id") @db.Uuid

  // Relations
  menu            Menu     @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@unique([roleCode, menuId], name: "ux_cm_role_menu_r_role_menu")
  @@index([menuId], name: "ix_cm_role_menu_r_menu")
  @@index([roleCode], name: "ix_cm_role_menu_r_role")
  @@map("cm_role_menu_r")
  @@schema("pms")
}

// ============================================
// Role Menu History - cm_role_menu_h
// ============================================
model RoleMenuHistory {
  roleMenuId      BigInt   @map("role_menu_id")
  historySeq      BigInt   @map("history_seq")
  
  eventType       String   @map("event_type") @db.Char(1) // C, U, D
  eventAt         DateTime @map("event_at")

  roleCode        String   @map("role_code")
  menuId          BigInt   @map("menu_id")
  accessType      String   @map("access_type")

  isActive        Boolean  @map("is_active")
  memo            String?
  createdBy       BigInt?  @map("created_by")
  createdAt       DateTime @map("created_at")
  updatedBy       BigInt?  @map("updated_by")
  updatedAt       DateTime @map("updated_at")
  lastSource      String?  @map("last_source")
  lastActivity    String?  @map("last_activity")
  transactionId   String?  @map("transaction_id") @db.Uuid

  @@id([roleMenuId, historySeq], name: "pk_cm_role_menu_h")
  @@index([eventAt], name: "ix_cm_role_menu_h_event_at")
  @@index([transactionId], name: "ix_cm_role_menu_h_tx")
  @@map("cm_role_menu_h")
  @@schema("pms")
}

// ============================================
// User Menu (사용자별 메뉴 권한 예외) - cm_user_menu_r
// ============================================
model UserMenu {
  id              BigInt   @id @default(autoincrement()) @map("user_menu_id")
  
  userId          BigInt   @map("user_id")
  menuId          BigInt   @map("menu_id")
  accessType      String   @default("full") @map("access_type") // full, read, none
  overrideType    String   @default("grant") @map("override_type") // grant, revoke
  
  expiresAt       DateTime? @map("expires_at") // 권한 만료일 (임시 권한)
  grantedBy       BigInt?  @map("granted_by")
  grantedAt       DateTime? @map("granted_at")
  grantReason     String?  @map("grant_reason")
  
  // Common columns
  isActive        Boolean  @default(true) @map("is_active")
  memo            String?
  createdBy       BigInt?  @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedBy       BigInt?  @map("updated_by")
  updatedAt       DateTime @updatedAt @map("updated_at")
  lastSource      String?  @map("last_source")
  lastActivity    String?  @map("last_activity")
  transactionId   String?  @map("transaction_id") @db.Uuid

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  menu            Menu     @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@unique([userId, menuId], name: "ux_cm_user_menu_r_user_menu")
  @@index([userId], name: "ix_cm_user_menu_r_user")
  @@index([expiresAt], name: "ix_cm_user_menu_r_expires")
  @@map("cm_user_menu_r")
  @@schema("pms")
}

// ============================================
// User Menu History - cm_user_menu_h
// ============================================
model UserMenuHistory {
  userMenuId      BigInt   @map("user_menu_id")
  historySeq      BigInt   @map("history_seq")
  
  eventType       String   @map("event_type") @db.Char(1) // C, U, D
  eventAt         DateTime @map("event_at")

  userId          BigInt   @map("user_id")
  menuId          BigInt   @map("menu_id")
  accessType      String   @map("access_type")
  overrideType    String   @map("override_type")
  expiresAt       DateTime? @map("expires_at")
  grantedBy       BigInt?  @map("granted_by")
  grantedAt       DateTime? @map("granted_at")
  grantReason     String?  @map("grant_reason")

  isActive        Boolean  @map("is_active")
  memo            String?
  createdBy       BigInt?  @map("created_by")
  createdAt       DateTime @map("created_at")
  updatedBy       BigInt?  @map("updated_by")
  updatedAt       DateTime @map("updated_at")
  lastSource      String?  @map("last_source")
  lastActivity    String?  @map("last_activity")
  transactionId   String?  @map("transaction_id") @db.Uuid

  @@id([userMenuId, historySeq], name: "pk_cm_user_menu_h")
  @@index([eventAt], name: "ix_cm_user_menu_h_event_at")
  @@index([transactionId], name: "ix_cm_user_menu_h_tx")
  @@map("cm_user_menu_h")
  @@schema("pms")
}

// ============================================
// User Favorite (사용자 즐겨찾기 메뉴) - cm_user_favorite_r
// 히스토리 미적용 (단순 ON/OFF 성격)
// ============================================
model UserFavorite {
  id              BigInt   @id @default(autoincrement()) @map("user_favorite_id")
  
  userId          BigInt   @map("user_id")
  menuId          BigInt   @map("menu_id")
  sortOrder       Int      @default(0) @map("sort_order") // 즐겨찾기 내 정렬 순서
  
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  menu            Menu     @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@unique([userId, menuId], name: "ux_cm_user_favorite_r_user_menu")
  @@index([userId], name: "ix_cm_user_favorite_r_user")
  @@map("cm_user_favorite_r")
  @@schema("pms")
}

// ============================================
// User (사용자) - cm_user_m
// 시스템 사용자와 프로젝트 리소스/이해관계자 통합 관리
// ============================================
model User {
  id              BigInt   @id @default(autoincrement()) @map("user_id")
  
  // System Access Control
  isSystemUser    Boolean  @default(false) @map("is_system_user")
  isAdmin         Boolean  @default(false) @map("is_admin") // 관리자 여부 (관리자 메뉴 접근)
  userTypeCode    String   @default("internal") @map("user_type_code") // internal, external
  
  // Authentication (nullable - only for isSystemUser = true)
  loginId         String?  @unique @map("login_id")
  passwordHash    String?  @map("password_hash")
  passwordSalt    String?  @map("password_salt")
  
  // Profile
  userName        String   @map("user_name")
  displayName     String?  @map("display_name")
  email           String   @unique
  phone           String?
  avatarUrl       String?  @map("avatar_url")
  
  // Organization (internal)
  departmentCode  String?  @map("department_code")
  positionCode    String?  @map("position_code")
  employeeNumber  String?  @map("employee_number")
  
  // Organization (external)
  companyName     String?  @map("company_name")
  customerId      BigInt?  @map("customer_id")
  
  // Role & Permission
  roleCode        String   @default("viewer") @map("role_code") // admin, manager, user, viewer
  permissionCodes String[] @map("permission_codes")
  
  // Status
  userStatusCode  String   @default("registered") @map("user_status_code") // registered, invited, active, inactive, suspended
  lastLoginAt     DateTime? @map("last_login_at")
  loginFailCount  Int      @default(0) @map("login_fail_count")
  lockedUntil     DateTime? @map("locked_until")
  
  // Invitation
  invitedAt       DateTime? @map("invited_at")
  invitedBy       BigInt?   @map("invited_by")
  invitationTokenHash String? @map("invitation_token_hash")
  invitationExpiresAt DateTime? @map("invitation_expires_at")
  
  // Token (Refresh Token for JWT)
  refreshTokenHash String? @map("refresh_token_hash")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")
  
  // Common columns
  isActive        Boolean  @default(true) @map("is_active")
  memo            String?
  createdBy       BigInt?  @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedBy       BigInt?  @map("updated_by")
  updatedAt       DateTime @updatedAt @map("updated_at")
  lastSource      String?  @map("last_source")
  lastActivity    String?  @map("last_activity")
  transactionId   String?  @map("transaction_id") @db.Uuid

  // Self-relation for invitedBy
  inviter         User?    @relation("UserInviter", fields: [invitedBy], references: [id], onDelete: SetNull)
  invitees        User[]   @relation("UserInviter")

  // Relations - as project owner
  ownedProjects   Project[] @relation("ProjectOwner")
  
  // Relations - menu permissions
  userMenus       UserMenu[]
  
  // Relations - favorites
  userFavorites   UserFavorite[]

  @@map("cm_user_m")
  @@schema("common")
}

// ============================================
// Project (프로젝트) - pr_project_m
// status_code: request → proposal → execution → transition
// stage_code: waiting → in_progress → done
// ============================================
model Project {
  id                    BigInt   @id @default(autoincrement()) @map("project_id")
  
  projectName           String   @map("project_name")
  statusCode            String   @map("status_code") // request, proposal, execution, transition
  stageCode             String   @map("stage_code") // waiting, in_progress, done
  doneResultCode        String?  @map("done_result_code") // accepted, rejected, won, lost, completed, cancelled, transferred, hold
  
  currentOwnerUserId    BigInt?  @map("current_owner_user_id")
  
  // Handoff
  handoffTypeCode       String?  @map("handoff_type_code") // REQ_TO_PRE, PRE_TO_PM, PM_TO_SM, etc.
  handoffStatusCode     String?  @map("handoff_status_code") // waiting, in_progress, done
  handoffRequestedAt    DateTime? @map("handoff_requested_at")
  handoffConfirmedAt    DateTime? @map("handoff_confirmed_at")
  handoffConfirmedBy    BigInt?  @map("handoff_confirmed_by")
  
  // Customer (external relations - logical FK)
  customerId            BigInt?  @map("customer_id")
  plantId               BigInt?  @map("plant_id")
  systemInstanceId      BigInt?  @map("system_instance_id")
  
  // Common columns
  isActive              Boolean  @default(true) @map("is_active")
  memo                  String?
  createdBy             BigInt?  @map("created_by")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedBy             BigInt?  @map("updated_by")
  updatedAt             DateTime @updatedAt @map("updated_at")
  lastSource            String?  @map("last_source")
  lastActivity          String?  @map("last_activity")
  transactionId         String?  @map("transaction_id") @db.Uuid

  // Relations
  currentOwner          User?    @relation("ProjectOwner", fields: [currentOwnerUserId], references: [id], onDelete: SetNull)
  projectStatuses       ProjectStatus[]
  projectDeliverables   ProjectDeliverable[]
  projectCloseConditions ProjectCloseCondition[]

  @@index([statusCode, stageCode], name: "ix_pr_project_m_status_stage")
  @@index([currentOwnerUserId], name: "ix_pr_project_m_owner")
  @@index([customerId], name: "ix_pr_project_m_customer")
  @@index([systemInstanceId], name: "ix_pr_project_m_system_instance")
  @@index([handoffStatusCode], name: "ix_pr_project_m_handoff")
  @@index([updatedAt], name: "ix_pr_project_m_updated_at")
  @@map("pr_project_m")
  @@schema("pms")
}

// ============================================
// Project Status (프로젝트 상태 상세) - pr_project_status_m
// PK: (project_id, status_code)
// status_code: request, proposal, execution, transition
// ============================================
model ProjectStatus {
  projectId               BigInt   @map("project_id")
  statusCode              String   @map("status_code") // request, proposal, execution, transition
  
  statusGoal              String   @map("status_goal")
  statusOwnerUserId       BigInt?  @map("status_owner_user_id")
  
  expectedStartAt         DateTime? @map("expected_start_at") @db.Date
  expectedEndAt           DateTime? @map("expected_end_at") @db.Date
  actualStartAt           DateTime? @map("actual_start_at") @db.Date
  actualEndAt             DateTime? @map("actual_end_at") @db.Date
  
  closeConditionGroupCode String?  @map("close_condition_group_code")
  
  // Common columns
  isActive                Boolean  @default(true) @map("is_active")
  memo                    String?
  createdBy               BigInt?  @map("created_by")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedBy               BigInt?  @map("updated_by")
  updatedAt               DateTime @updatedAt @map("updated_at")
  lastSource              String?  @map("last_source")
  lastActivity            String?  @map("last_activity")
  transactionId           String?  @map("transaction_id") @db.Uuid

  // Relations
  project                 Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@id([projectId, statusCode], name: "pk_pr_project_status_m")
  @@index([statusOwnerUserId], name: "ix_pr_project_status_m_owner")
  @@index([expectedStartAt, expectedEndAt], name: "ix_pr_project_status_m_dates")
  @@index([updatedAt], name: "ix_pr_project_status_m_updated_at")
  @@map("pr_project_status_m")
  @@schema("pms")
}

// ============================================
// Deliverable (산출물 마스터) - pr_deliverable_m
// ============================================
model Deliverable {
  id                BigInt   @id @default(autoincrement()) @map("deliverable_id")
  
  deliverableCode   String   @unique @map("deliverable_code")
  deliverableName   String   @map("deliverable_name")
  description       String?
  sortOrder         Int      @default(0) @map("sort_order")

  // Common columns
  isActive          Boolean  @default(true) @map("is_active")
  memo              String?
  createdBy         BigInt?  @map("created_by")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedBy         BigInt?  @map("updated_by")
  updatedAt         DateTime @updatedAt @map("updated_at")
  lastSource        String?  @map("last_source")
  lastActivity      String?  @map("last_activity")
  transactionId     String?  @map("transaction_id") @db.Uuid

  // Relations
  projectDeliverables ProjectDeliverable[]
  groupItems          DeliverableGroupItem[]

  @@index([isActive], name: "ix_pr_deliverable_m_active")
  @@index([sortOrder], name: "ix_pr_deliverable_m_sort")
  @@map("pr_deliverable_m")
  @@schema("pms")
}

// ============================================
// Deliverable Group (산출물 그룹 마스터) - pr_deliverable_group_m
// ============================================
model DeliverableGroup {
  id              BigInt   @id @default(autoincrement()) @map("deliverable_group_id")
  
  groupCode       String   @unique @map("group_code")
  groupName       String   @map("group_name")
  description     String?
  sortOrder       Int      @default(0) @map("sort_order")

  // Common columns
  isActive        Boolean  @default(true) @map("is_active")
  memo            String?
  createdBy       BigInt?  @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedBy       BigInt?  @map("updated_by")
  updatedAt       DateTime @updatedAt @map("updated_at")
  lastSource      String?  @map("last_source")
  lastActivity    String?  @map("last_activity")
  transactionId   String?  @map("transaction_id") @db.Uuid

  // Relations
  groupItems      DeliverableGroupItem[]

  @@index([isActive], name: "ix_pr_deliverable_group_m_active")
  @@index([sortOrder], name: "ix_pr_deliverable_group_m_sort")
  @@map("pr_deliverable_group_m")
  @@schema("pms")
}

// ============================================
// Deliverable Group Item (산출물 그룹-항목 매핑) - pr_deliverable_group_item_r_m
// PK: (group_code, deliverable_code)
// ============================================
model DeliverableGroupItem {
  groupCode         String   @map("group_code")
  deliverableCode   String   @map("deliverable_code")
  
  sortOrder         Int      @default(0) @map("sort_order")

  // Common columns
  isActive          Boolean  @default(true) @map("is_active")
  memo              String?
  createdBy         BigInt?  @map("created_by")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedBy         BigInt?  @map("updated_by")
  updatedAt         DateTime @updatedAt @map("updated_at")
  lastSource        String?  @map("last_source")
  lastActivity      String?  @map("last_activity")
  transactionId     String?  @map("transaction_id") @db.Uuid

  // Relations
  group             DeliverableGroup @relation(fields: [groupCode], references: [groupCode], onDelete: Cascade)
  deliverable       Deliverable      @relation(fields: [deliverableCode], references: [deliverableCode], onDelete: Cascade)

  @@id([groupCode, deliverableCode], name: "pk_pr_deliverable_group_item_r_m")
  @@index([isActive], name: "ix_pr_deliverable_group_item_r_m_active")
  @@index([deliverableCode], name: "ix_pr_deliverable_group_item_r_m_deliverable")
  @@index([groupCode, sortOrder], name: "ix_pr_deliverable_group_item_r_m_sort")
  @@map("pr_deliverable_group_item_r_m")
  @@schema("pms")
}

// ============================================
// Close Condition Group (종료조건 그룹 마스터) - pr_close_condition_group_m
// ============================================
model CloseConditionGroup {
  id              BigInt   @id @default(autoincrement()) @map("close_condition_group_id")
  
  groupCode       String   @unique @map("group_code")
  groupName       String   @map("group_name")
  description     String?
  sortOrder       Int      @default(0) @map("sort_order")

  // Common columns
  isActive        Boolean  @default(true) @map("is_active")
  memo            String?
  createdBy       BigInt?  @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedBy       BigInt?  @map("updated_by")
  updatedAt       DateTime @updatedAt @map("updated_at")
  lastSource      String?  @map("last_source")
  lastActivity    String?  @map("last_activity")
  transactionId   String?  @map("transaction_id") @db.Uuid

  // Relations
  groupItems      CloseConditionGroupItem[]

  @@index([isActive], name: "ix_pr_close_condition_group_m_active")
  @@index([sortOrder], name: "ix_pr_close_condition_group_m_sort")
  @@map("pr_close_condition_group_m")
  @@schema("pms")
}

// ============================================
// Close Condition Group Item (종료조건 그룹-항목 매핑) - pr_close_condition_group_item_r_m
// PK: (group_code, condition_code)
// ============================================
model CloseConditionGroupItem {
  groupCode       String   @map("group_code")
  conditionCode   String   @map("condition_code")
  
  sortOrder       Int      @default(0) @map("sort_order")

  // Common columns
  isActive        Boolean  @default(true) @map("is_active")
  memo            String?
  createdBy       BigInt?  @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedBy       BigInt?  @map("updated_by")
  updatedAt       DateTime @updatedAt @map("updated_at")
  lastSource      String?  @map("last_source")
  lastActivity    String?  @map("last_activity")
  transactionId   String?  @map("transaction_id") @db.Uuid

  // Relations
  group           CloseConditionGroup @relation(fields: [groupCode], references: [groupCode], onDelete: Cascade)

  @@id([groupCode, conditionCode], name: "pk_pr_close_condition_group_item_r_m")
  @@index([isActive], name: "ix_pr_close_condition_group_item_r_m_active")
  @@index([conditionCode], name: "ix_pr_close_condition_group_item_r_m_condition")
  @@index([groupCode, sortOrder], name: "ix_pr_close_condition_group_item_r_m_sort")
  @@map("pr_close_condition_group_item_r_m")
  @@schema("pms")
}

// ============================================
// Project Deliverable (프로젝트 산출물 매핑) - pr_project_deliverable_r_m
// PK: (project_id, status_code, deliverable_code)
// status_code: request, proposal, execution, transition
// ============================================
model ProjectDeliverable {
  projectId             BigInt   @map("project_id")
  statusCode            String   @map("status_code") // request, proposal, execution, transition
  deliverableCode       String   @map("deliverable_code")
  
  submissionStatusCode  String   @map("submission_status_code")
  submittedAt           DateTime? @map("submitted_at")
  submittedBy           BigInt?  @map("submitted_by")
  
  // File reference
  storageObjectKey      String?  @map("storage_object_key")
  originalFileName      String?  @map("original_file_name")
  mimeType              String?  @map("mime_type") @db.VarChar(100)
  fileSizeBytes         BigInt?  @map("file_size_bytes")

  // Common columns
  isActive              Boolean  @default(true) @map("is_active")
  memo                  String?
  createdBy             BigInt?  @map("created_by")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedBy             BigInt?  @map("updated_by")
  updatedAt             DateTime @updatedAt @map("updated_at")
  lastSource            String?  @map("last_source")
  lastActivity          String?  @map("last_activity")
  transactionId         String?  @map("transaction_id") @db.Uuid

  // Relations
  project               Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  deliverable           Deliverable @relation(fields: [deliverableCode], references: [deliverableCode], onDelete: Cascade)

  @@id([projectId, statusCode, deliverableCode], name: "pk_pr_project_deliverable_r_m")
  @@index([projectId, statusCode, submissionStatusCode], name: "ix_pr_project_deliverable_r_m_status")
  @@index([deliverableCode], name: "ix_pr_project_deliverable_r_m_deliverable")
  @@index([updatedAt], name: "ix_pr_project_deliverable_r_m_updated_at")
  @@map("pr_project_deliverable_r_m")
  @@schema("pms")
}

// ============================================
// Project Close Condition (프로젝트 종료조건 매핑) - pr_project_close_condition_r_m
// PK: (project_id, status_code, condition_code)
// status_code: request, proposal, execution, transition
// ============================================
model ProjectCloseCondition {
  projectId       BigInt   @map("project_id")
  statusCode      String   @map("status_code") // request, proposal, execution, transition
  conditionCode   String   @map("condition_code")
  
  requiresDeliverable Boolean @default(false) @map("requires_deliverable")
  isChecked       Boolean  @default(false) @map("is_checked")
  checkedAt       DateTime? @map("checked_at")
  checkedBy       BigInt?  @map("checked_by")
  
  sortOrder       Int      @default(0) @map("sort_order")

  // Common columns
  isActive        Boolean  @default(true) @map("is_active")
  memo            String?
  createdBy       BigInt?  @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedBy       BigInt?  @map("updated_by")
  updatedAt       DateTime @updatedAt @map("updated_at")
  lastSource      String?  @map("last_source")
  lastActivity    String?  @map("last_activity")
  transactionId   String?  @map("transaction_id") @db.Uuid

  // Relations
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@id([projectId, statusCode, conditionCode], name: "pk_pr_project_close_condition_r_m")
  @@index([projectId, statusCode, isChecked], name: "ix_pr_project_close_condition_r_m_checked")
  @@index([conditionCode], name: "ix_pr_project_close_condition_r_m_condition")
  @@index([updatedAt], name: "ix_pr_project_close_condition_r_m_updated_at")
  @@map("pr_project_close_condition_r_m")
  @@schema("pms")
}

// ============================================
// HISTORY TABLES
// ============================================

// ============================================
// User History - cm_user_h
// ============================================
model UserHistory {
  userId          BigInt   @map("user_id")
  historySeq      BigInt   @map("history_seq")
  
  eventType       String   @map("event_type") @db.Char(1) // C, U, D
  eventAt         DateTime @map("event_at")

  isSystemUser    Boolean  @map("is_system_user")
  isAdmin         Boolean  @default(false) @map("is_admin")
  userTypeCode    String   @map("user_type_code")
  loginId         String?  @map("login_id")
  passwordHash    String?  @map("password_hash")
  passwordSalt    String?  @map("password_salt")
  userName        String   @map("user_name")
  displayName     String?  @map("display_name")
  email           String
  phone           String?
  avatarUrl       String?  @map("avatar_url")
  departmentCode  String?  @map("department_code")
  positionCode    String?  @map("position_code")
  employeeNumber  String?  @map("employee_number")
  companyName     String?  @map("company_name")
  customerId      BigInt?  @map("customer_id")
  roleCode        String   @map("role_code")
  permissionCodes String[] @map("permission_codes")
  userStatusCode  String   @map("user_status_code")
  lastLoginAt     DateTime? @map("last_login_at")
  loginFailCount  Int      @map("login_fail_count")
  lockedUntil     DateTime? @map("locked_until")
  invitedAt       DateTime? @map("invited_at")
  invitedBy       BigInt?   @map("invited_by")
  invitationTokenHash String? @map("invitation_token_hash")
  invitationExpiresAt DateTime? @map("invitation_expires_at")
  refreshTokenHash String? @map("refresh_token_hash")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")

  isActive        Boolean  @map("is_active")
  memo            String?
  createdBy       BigInt?  @map("created_by")
  createdAt       DateTime @map("created_at")
  updatedBy       BigInt?  @map("updated_by")
  updatedAt       DateTime @map("updated_at")
  lastSource      String?  @map("last_source")
  lastActivity    String?  @map("last_activity")
  transactionId   String?  @map("transaction_id") @db.Uuid

  @@id([userId, historySeq], name: "pk_cm_user_h")
  @@index([eventAt], name: "ix_cm_user_h_event_at")
  @@index([transactionId], name: "ix_cm_user_h_tx")
  @@map("cm_user_h")
  @@schema("common")
}

// ============================================
// Project History - pr_project_h
// ============================================
model ProjectHistory {
  projectId             BigInt   @map("project_id")
  historySeq            BigInt   @map("history_seq")
  
  eventType             String   @map("event_type") @db.Char(1)
  eventAt               DateTime @map("event_at")

  projectName           String   @map("project_name")
  statusCode            String   @map("status_code")
  stageCode             String   @map("stage_code")
  doneResultCode        String?  @map("done_result_code")
  currentOwnerUserId    BigInt?  @map("current_owner_user_id")
  handoffTypeCode       String?  @map("handoff_type_code")
  handoffStatusCode     String?  @map("handoff_status_code")
  handoffRequestedAt    DateTime? @map("handoff_requested_at")
  handoffConfirmedAt    DateTime? @map("handoff_confirmed_at")
  handoffConfirmedBy    BigInt?  @map("handoff_confirmed_by")
  customerId            BigInt?  @map("customer_id")
  plantId               BigInt?  @map("plant_id")
  systemInstanceId      BigInt?  @map("system_instance_id")

  isActive              Boolean  @map("is_active")
  memo                  String?
  createdBy             BigInt?  @map("created_by")
  createdAt             DateTime @map("created_at")
  updatedBy             BigInt?  @map("updated_by")
  updatedAt             DateTime @map("updated_at")
  lastSource            String?  @map("last_source")
  lastActivity          String?  @map("last_activity")
  transactionId         String?  @map("transaction_id") @db.Uuid

  @@id([projectId, historySeq], name: "pk_pr_project_h")
  @@index([eventAt], name: "ix_pr_project_h_event_at")
  @@index([transactionId], name: "ix_pr_project_h_tx")
  @@map("pr_project_h")
  @@schema("pms")
}

// ============================================
// Project Status History - pr_project_status_h
// ============================================
model ProjectStatusHistory {
  projectId               BigInt   @map("project_id")
  statusCode              String   @map("status_code")
  historySeq              BigInt   @map("history_seq")
  
  eventType               String   @map("event_type") @db.Char(1)
  eventAt                 DateTime @map("event_at")

  statusGoal              String   @map("status_goal")
  statusOwnerUserId       BigInt?  @map("status_owner_user_id")
  expectedStartAt         DateTime? @map("expected_start_at") @db.Date
  expectedEndAt           DateTime? @map("expected_end_at") @db.Date
  actualStartAt           DateTime? @map("actual_start_at") @db.Date
  actualEndAt             DateTime? @map("actual_end_at") @db.Date
  closeConditionGroupCode String?  @map("close_condition_group_code")

  isActive                Boolean  @map("is_active")
  memo                    String?
  createdBy               BigInt?  @map("created_by")
  createdAt               DateTime @map("created_at")
  updatedBy               BigInt?  @map("updated_by")
  updatedAt               DateTime @map("updated_at")
  lastSource              String?  @map("last_source")
  lastActivity            String?  @map("last_activity")
  transactionId           String?  @map("transaction_id") @db.Uuid

  @@id([projectId, statusCode, historySeq], name: "pk_pr_project_status_h")
  @@index([eventAt], name: "ix_pr_project_status_h_event_at")
  @@index([transactionId], name: "ix_pr_project_status_h_tx")
  @@map("pr_project_status_h")
  @@schema("pms")
}

// ============================================
// Deliverable History - pr_deliverable_h
// ============================================
model DeliverableHistory {
  deliverableId     BigInt   @map("deliverable_id")
  historySeq        BigInt   @map("history_seq")
  
  eventType         String   @map("event_type") @db.Char(1)
  eventAt           DateTime @map("event_at")

  deliverableCode   String   @map("deliverable_code")
  deliverableName   String   @map("deliverable_name")
  description       String?
  sortOrder         Int      @map("sort_order")

  isActive          Boolean  @map("is_active")
  memo              String?
  createdBy         BigInt?  @map("created_by")
  createdAt         DateTime @map("created_at")
  updatedBy         BigInt?  @map("updated_by")
  updatedAt         DateTime @map("updated_at")
  lastSource        String?  @map("last_source")
  lastActivity      String?  @map("last_activity")
  transactionId     String?  @map("transaction_id") @db.Uuid

  @@id([deliverableId, historySeq], name: "pk_pr_deliverable_h")
  @@index([eventAt], name: "ix_pr_deliverable_h_event_at")
  @@index([transactionId], name: "ix_pr_deliverable_h_tx")
  @@map("pr_deliverable_h")
  @@schema("pms")
}

// ============================================
// Deliverable Group History - pr_deliverable_group_h
// ============================================
model DeliverableGroupHistory {
  deliverableGroupId BigInt   @map("deliverable_group_id")
  historySeq         BigInt   @map("history_seq")
  
  eventType          String   @map("event_type") @db.Char(1)
  eventAt            DateTime @map("event_at")

  groupCode          String   @map("group_code")
  groupName          String   @map("group_name")
  description        String?
  sortOrder          Int      @map("sort_order")

  isActive           Boolean  @map("is_active")
  memo               String?
  createdBy          BigInt?  @map("created_by")
  createdAt          DateTime @map("created_at")
  updatedBy          BigInt?  @map("updated_by")
  updatedAt          DateTime @map("updated_at")
  lastSource         String?  @map("last_source")
  lastActivity       String?  @map("last_activity")
  transactionId      String?  @map("transaction_id") @db.Uuid

  @@id([deliverableGroupId, historySeq], name: "pk_pr_deliverable_group_h")
  @@index([eventAt], name: "ix_pr_deliverable_group_h_event_at")
  @@index([transactionId], name: "ix_pr_deliverable_group_h_tx")
  @@map("pr_deliverable_group_h")
  @@schema("pms")
}

// ============================================
// Deliverable Group Item History - pr_deliverable_group_item_r_h
// ============================================
model DeliverableGroupItemHistory {
  groupCode         String   @map("group_code")
  deliverableCode   String   @map("deliverable_code")
  historySeq        BigInt   @map("history_seq")
  
  eventType         String   @map("event_type") @db.Char(1)
  eventAt           DateTime @map("event_at")

  sortOrder         Int      @map("sort_order")

  isActive          Boolean  @map("is_active")
  memo              String?
  createdBy         BigInt?  @map("created_by")
  createdAt         DateTime @map("created_at")
  updatedBy         BigInt?  @map("updated_by")
  updatedAt         DateTime @map("updated_at")
  lastSource        String?  @map("last_source")
  lastActivity      String?  @map("last_activity")
  transactionId     String?  @map("transaction_id") @db.Uuid

  @@id([groupCode, deliverableCode, historySeq], name: "pk_pr_deliverable_group_item_r_h")
  @@index([eventAt], name: "ix_pr_deliverable_group_item_r_h_event_at")
  @@index([transactionId], name: "ix_pr_deliverable_group_item_r_h_tx")
  @@map("pr_deliverable_group_item_r_h")
  @@schema("pms")
}

// ============================================
// Close Condition Group History - pr_close_condition_group_h
// ============================================
model CloseConditionGroupHistory {
  closeConditionGroupId BigInt   @map("close_condition_group_id")
  historySeq            BigInt   @map("history_seq")
  
  eventType             String   @map("event_type") @db.Char(1)
  eventAt               DateTime @map("event_at")

  groupCode             String   @map("group_code")
  groupName             String   @map("group_name")
  description           String?
  sortOrder             Int      @map("sort_order")

  isActive              Boolean  @map("is_active")
  memo                  String?
  createdBy             BigInt?  @map("created_by")
  createdAt             DateTime @map("created_at")
  updatedBy             BigInt?  @map("updated_by")
  updatedAt             DateTime @map("updated_at")
  lastSource            String?  @map("last_source")
  lastActivity          String?  @map("last_activity")
  transactionId         String?  @map("transaction_id") @db.Uuid

  @@id([closeConditionGroupId, historySeq], name: "pk_pr_close_condition_group_h")
  @@index([eventAt], name: "ix_pr_close_condition_group_h_event_at")
  @@index([transactionId], name: "ix_pr_close_condition_group_h_tx")
  @@map("pr_close_condition_group_h")
  @@schema("pms")
}

// ============================================
// Close Condition Group Item History - pr_close_condition_group_item_r_h
// ============================================
model CloseConditionGroupItemHistory {
  groupCode       String   @map("group_code")
  conditionCode   String   @map("condition_code")
  historySeq      BigInt   @map("history_seq")
  
  eventType       String   @map("event_type") @db.Char(1)
  eventAt         DateTime @map("event_at")

  sortOrder       Int      @map("sort_order")

  isActive        Boolean  @map("is_active")
  memo            String?
  createdBy       BigInt?  @map("created_by")
  createdAt       DateTime @map("created_at")
  updatedBy       BigInt?  @map("updated_by")
  updatedAt       DateTime @map("updated_at")
  lastSource      String?  @map("last_source")
  lastActivity    String?  @map("last_activity")
  transactionId   String?  @map("transaction_id") @db.Uuid

  @@id([groupCode, conditionCode, historySeq], name: "pk_pr_close_condition_group_item_r_h")
  @@index([eventAt], name: "ix_pr_close_condition_group_item_r_h_event_at")
  @@index([transactionId], name: "ix_pr_close_condition_group_item_r_h_tx")
  @@map("pr_close_condition_group_item_r_h")
  @@schema("pms")
}

// ============================================
// Project Deliverable History - pr_project_deliverable_r_h
// ============================================
model ProjectDeliverableHistory {
  projectId             BigInt   @map("project_id")
  statusCode            String   @map("status_code")
  deliverableCode       String   @map("deliverable_code")
  historySeq            BigInt   @map("history_seq")
  
  eventType             String   @map("event_type") @db.Char(1)
  eventAt               DateTime @map("event_at")

  submissionStatusCode  String   @map("submission_status_code")
  submittedAt           DateTime? @map("submitted_at")
  submittedBy           BigInt?  @map("submitted_by")
  storageObjectKey      String?  @map("storage_object_key")
  originalFileName      String?  @map("original_file_name")
  mimeType              String?  @map("mime_type") @db.VarChar(100)
  fileSizeBytes         BigInt?  @map("file_size_bytes")

  isActive              Boolean  @map("is_active")
  memo                  String?
  createdBy             BigInt?  @map("created_by")
  createdAt             DateTime @map("created_at")
  updatedBy             BigInt?  @map("updated_by")
  updatedAt             DateTime @map("updated_at")
  lastSource            String?  @map("last_source")
  lastActivity          String?  @map("last_activity")
  transactionId         String?  @map("transaction_id") @db.Uuid

  @@id([projectId, statusCode, deliverableCode, historySeq], name: "pk_pr_project_deliverable_r_h")
  @@index([eventAt], name: "ix_pr_project_deliverable_r_h_event_at")
  @@index([transactionId], name: "ix_pr_project_deliverable_r_h_tx")
  @@map("pr_project_deliverable_r_h")
  @@schema("pms")
}

// ============================================
// Project Close Condition History - pr_project_close_condition_r_h
// ============================================
model ProjectCloseConditionHistory {
  projectId       BigInt   @map("project_id")
  statusCode      String   @map("status_code")
  conditionCode   String   @map("condition_code")
  historySeq      BigInt   @map("history_seq")
  
  eventType       String   @map("event_type") @db.Char(1)
  eventAt         DateTime @map("event_at")

  requiresDeliverable Boolean @map("requires_deliverable")
  isChecked       Boolean  @map("is_checked")
  checkedAt       DateTime? @map("checked_at")
  checkedBy       BigInt?  @map("checked_by")
  sortOrder       Int      @map("sort_order")

  isActive        Boolean  @map("is_active")
  memo            String?
  createdBy       BigInt?  @map("created_by")
  createdAt       DateTime @map("created_at")
  updatedBy       BigInt?  @map("updated_by")
  updatedAt       DateTime @map("updated_at")
  lastSource      String?  @map("last_source")
  lastActivity    String?  @map("last_activity")
  transactionId   String?  @map("transaction_id") @db.Uuid

  @@id([projectId, statusCode, conditionCode, historySeq], name: "pk_pr_project_close_condition_r_h")
  @@index([eventAt], name: "ix_pr_project_close_condition_r_h_event_at")
  @@index([transactionId], name: "ix_pr_project_close_condition_r_h_tx")
  @@map("pr_project_close_condition_r_h")
  @@schema("pms")
}
