# PR Í≤ÄÏ¶ù ÏõåÌÅ¨ÌîåÎ°úÏö∞
#
# PR ÏÉùÏÑ±/ÏóÖÎç∞Ïù¥Ìä∏ Ïãú ÏûêÎèôÏúºÎ°ú Ïã§ÌñâÎêòÏñ¥ ÏΩîÎìú ÌíàÏßàÏùÑ Í≤ÄÏ¶ùÌï©ÎãàÎã§.
# - Î¶∞Ìä∏ Í≤ÄÏÇ¨
# - ÌÉÄÏûÖ Ï≤¥ÌÅ¨
# - ÎπåÎìú Í≤ÄÏ¶ù
# - Ìå®ÌÑ¥ Í≤ÄÏ¶ù

name: PR Validation

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Type Check (Server)
        run: pnpm --filter server exec tsc --noEmit

      - name: Type Check (PMS)
        run: pnpm --filter web-pms exec tsc --noEmit

      - name: Build Database Package
        run: pnpm --filter @ssoo/database build

      - name: Build Types Package
        run: pnpm --filter @ssoo/types build

      - name: Pattern Check
        run: |
          # Î≥ÄÍ≤ΩÎêú ÌååÏùº Î™©Î°ù
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(ts|tsx)$' || true)
          
          if [ -n "$CHANGED_FILES" ]; then
            echo "Í≤ÄÏ¶ùÌï† ÌååÏùº:"
            echo "$CHANGED_FILES"
            echo ""
            node scripts/check-patterns.js $CHANGED_FILES
          else
            echo "Í≤ÄÏ¶ùÌï† TypeScript ÌååÏùº ÏóÜÏùå"
          fi

      - name: Docs Check
        run: |
          # Î≥ÄÍ≤ΩÎêú Î¨∏ÏÑú ÌååÏùº Î™©Î°ù
          CHANGED_DOCS=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '^docs/.*\.md$' || true)
          
          if [ -n "$CHANGED_DOCS" ]; then
            echo "Í≤ÄÏ¶ùÌï† Î¨∏ÏÑú:"
            echo "$CHANGED_DOCS"
            echo ""
            node scripts/check-docs.js $CHANGED_DOCS
          else
            echo "Í≤ÄÏ¶ùÌï† Î¨∏ÏÑú ÌååÏùº ÏóÜÏùå"
          fi

  # Î≥ÄÍ≤Ω Î≤îÏúÑ Î∂ÑÏÑù
  analyze-changes:
    name: Analyze Changes
    runs-on: ubuntu-latest
    outputs:
      server: ${{ steps.filter.outputs.server }}
      pms: ${{ steps.filter.outputs.pms }}
      dms: ${{ steps.filter.outputs.dms }}
      database: ${{ steps.filter.outputs.database }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Filter paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            server:
              - 'apps/server/**'
            pms:
              - 'apps/web/pms/**'
            dms:
              - 'apps/web/dms/**'
            database:
              - 'packages/database/**'

  # ÏÑúÎ≤Ñ ÎπåÎìú (ÏÑúÎ≤Ñ Î≥ÄÍ≤Ω ÏãúÏóêÎßå)
  build-server:
    name: Build Server
    needs: [validate, analyze-changes]
    if: needs.analyze-changes.outputs.server == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build:server

  # PMS ÎπåÎìú (PMS Î≥ÄÍ≤Ω ÏãúÏóêÎßå)
  build-pms:
    name: Build PMS
    needs: [validate, analyze-changes]
    if: needs.analyze-changes.outputs.pms == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build:web-pms

  # PR ÏΩîÎ©òÌä∏
  pr-comment:
    name: PR Summary
    needs: [validate, analyze-changes]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Post Summary
        uses: actions/github-script@v7
        with:
          script: |
            const validate = '${{ needs.validate.result }}';
            const server = '${{ needs.analyze-changes.outputs.server }}';
            const pms = '${{ needs.analyze-changes.outputs.pms }}';
            const dms = '${{ needs.analyze-changes.outputs.dms }}';
            const database = '${{ needs.analyze-changes.outputs.database }}';
            
            let body = '## üîç PR Í≤ÄÏ¶ù Í≤∞Í≥º\n\n';
            
            if (validate === 'success') {
              body += '‚úÖ **Í≤ÄÏ¶ù ÌÜµÍ≥º**\n\n';
            } else {
              body += '‚ùå **Í≤ÄÏ¶ù Ïã§Ìå®**\n\n';
            }
            
            body += '### Î≥ÄÍ≤Ω ÏòÅÏó≠\n\n';
            body += `| ÏòÅÏó≠ | Î≥ÄÍ≤Ω Ïó¨Î∂Ä |\n`;
            body += `|------|----------|\n`;
            body += `| Server | ${server === 'true' ? '‚úÖ' : '‚ûñ'} |\n`;
            body += `| PMS | ${pms === 'true' ? '‚úÖ' : '‚ûñ'} |\n`;
            body += `| DMS | ${dms === 'true' ? '‚úÖ' : '‚ûñ'} |\n`;
            body += `| Database | ${database === 'true' ? '‚úÖ' : '‚ûñ'} |\n`;
            
            // Í∏∞Ï°¥ ÏΩîÎ©òÌä∏ Ï∞æÍ∏∞
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('PR Í≤ÄÏ¶ù Í≤∞Í≥º')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }
