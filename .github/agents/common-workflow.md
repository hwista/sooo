# 에이전트 공통 워크플로우

> 모든 에이전트가 따라야 하는 공통 워크플로우 정의
> 이 파일은 각 에이전트에서 참조됩니다.

---

## 🔒 필수 참조 (작업 전 반드시 읽기)

> **경고**: 이 섹션의 파일들을 참조하지 않고 작업하면 일관성이 깨집니다.

### 항상 참조

| 파일 | 용도 | 참조 시점 |
|------|------|----------|
| `copilot-instructions.md` | 전역 규칙, 금지 사항 | 모든 작업 시작 전 |
| 기존 유사 코드 | 패턴 복제 대상 | 구현 전 |

### 경로별 참조

> **Note**: 아래는 예시입니다. 실제 경로는 프로젝트의 `copilot-instructions.md`에 정의된 폴더 구조를 따릅니다.

| 작업 경로 (예시) | 참조 파일 |
|-----------------|----------|
| `[backend-path]/**` | `instructions/[backend].instructions.md` |
| `[frontend-path]/**` | `instructions/[frontend].instructions.md` |
| `[database-path]/**` | `instructions/database.instructions.md` |
| `**/*.test.ts`, `**/*.spec.ts` | `instructions/testing.instructions.md` |

**instructions 파일 찾기**:
1. `.github/instructions/` 폴더 확인
2. 작업 경로와 매칭되는 파일 선택
3. 없으면 `copilot-instructions.md`만 참조

### 참조 체크리스트 (매 작업 시)

```
[ ] copilot-instructions.md 읽음
[ ] 해당 경로 instructions 파일 읽음
[ ] 유사 기능의 기존 코드 분석함
[ ] 기존 패턴과 일치하게 작업할 것임
```

---

## 🔔 에이전트 표시 프로토콜 (필수)

> **투명성 원칙**: 사용자는 항상 현재 어떤 에이전트가 무슨 작업을 하는지 알아야 합니다.

### 에이전트 시작 시 표시

```markdown
---
## 🤖 에이전트 활성화

**현재 에이전트**: `@[에이전트명]`
**역할**: [역할 설명]
**수행 작업**: [이번에 수행할 작업 요약]
---
```

### 에이전트 전환 시 표시

```markdown
---
## 🔄 에이전트 전환

`@[이전 에이전트]` → `@[다음 에이전트]`

**이전 에이전트 완료 작업**: [완료 내용]
**다음 에이전트 예정 작업**: [예정 내용]
---
```

### 단일 에이전트 작업 시

복잡한 에이전트 체인 없이 단일 에이전트로 작업하는 경우에도 **반드시 표시**:

```markdown
---
## 🤖 작업 수행

**에이전트**: `@developer` (또는 일반 모드)
**작업**: [수행할 작업]
---
```

---

## 공통 워크플로우 루프

모든 에이전트는 다음 **8단계 루프**를 수행합니다:

```
┌─────────────────────────────────────────────────────────────────────────┐
│  1. 스펙     →  내 직무의 스펙/범위 정의                                  │
│       ↓                                                                 │
│  2. 검증 ⏸️  →  스펙 검증 (사용자 확인)                                   │
│       ↓                                                                 │
│  3. 계획     →  실행 계획 수립                                           │
│       ↓                                                                 │
│  4. 검증 ⏸️  →  계획 검증 (사용자 확인)                                   │
│       ↓                                                                 │
│  5. 실행     →  태스크 수행                                              │
│       ↓                                                                 │
│  6. 검증 ⏸️  →  결과 검증                                                │
│       ↓                                                                 │
│  7. 분석     →  결과 분석, 이슈 식별                                     │
│       ↓                                                                 │
│  8. 핸드오프 →  다음 에이전트로 전달 (또는 완료)                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 검증 포인트 (⏸️)

각 검증 포인트에서:

1. **산출물 요약 제시**
2. **확인 요청**: "계속 진행할까요?"
3. **이슈 있으면**: 수정 후 재검증
4. **승인 받으면**: 다음 단계로

---

## 공통 원칙 (모든 에이전트 적용)

### 0. 점검 우선 (Inspect First)

> **모든 작업의 첫 번째 단계는 점검**

```
❌ 잘못된 순서: 실행 → 점검
✅ 올바른 순서: 점검 → 분석 → 실행 → 검증
```

**점검 체크리스트**:
- [ ] 현재 상태 파악 (관련 코드, 문서)
- [ ] 기존 유사 기능 검색
- [ ] 영향 범위 식별
- [ ] 빌드/테스트 상태 확인

### 1. 코드 클렌징

- 사용되는 코드만 유지
- 불필요한 추상화 제거
- 미래 기능용 선제작 금지 (YAGNI)
- 일관된 패턴 유지

### 2. 문서-코드 동기화

- 코드 변경 → 문서 업데이트 → 커밋 순서
- 문서에 없으면 코드도 없어야 함
- Changelog 업데이트 필수

### 3. 증거 기반 작업

- 모든 발견에 증거 포함 (파일, 라인, grep)
- "~로 보임", "~일 것 같음" 금지
- 확신 없으면 "확인 필요" 표기
- 영향 범위 명시

### 4. 승인 프로세스

| 작업 | AI | 사용자 |
|------|-----|------|
| 점검/분석 | ✅ 수행 | 결과 확인 |
| 브리핑/제안 | ✅ 수행 | 검토 |
| **삭제/변경 결정** | 판단 제시 | 🔒 **최종 승인** |
| **실행** | ⏸️ 대기 | 🔒 **컨펌 후 지시** |

### 5. 기존 코드 참조 (일관성 필수)

> **새 코드 작성 전 반드시 기존 코드베이스 분석**

**필수 확인 항목**:
- [ ] 같은 도메인의 유사 기능 파일 검색
- [ ] 해당 파일의 패턴 분석 (구조, 네이밍, 스타일)
- [ ] 동일 패턴으로 구현

**일관성 검증**:
| 항목 | 확인 방법 |
|------|----------|
| 파일 구조 | 유사 파일과 동일한 디렉토리 구조 |
| 네이밍 규칙 | 컴포넌트 PascalCase, 훅 use접두사, 유틸 camelCase |
| 코드 스타일 | 기존 코드와 동일한 포맷팅/패턴 |
| 디자인 시스템 | 컨트롤 크기/색상/간격 기존과 일치 |
| 타입 정의 | 기존 DTO/Interface 패턴 준수 |

**새 패턴 도입 시**:
1. 기존 패턴 대비 장점 명시
2. 사용자 승인 필수
3. 관련 문서에 새 패턴 정의 추가

---

## 핸드오프 프로토콜

### 핸드오프 시 전달 내용

```markdown
## 핸드오프: @[현재 에이전트] → @[다음 에이전트]

### 완료된 작업
- [x] [작업 1]
- [x] [작업 2]

### 산출물
- `[파일 경로 1]`
- `[파일 경로 2]`

### 다음 에이전트 작업
- [ ] [다음 작업 1]
- [ ] [다음 작업 2]

### 주의사항
- [특이사항, 결정사항, 제약 등]
```

### 핸드오프 수신 시

1. 전달 내용 확인
2. 산출물 존재 여부 확인
3. 내 스펙 정의 시작

---

## 에이전트 체인

```
@orchestrator
    │
    ├─ @planner ─────────────────────────┐
    │                                    │
    ├─ @architect ───────────────────────┤
    │                                    │
    ├─ @dba (선택적) ────────────────────┤  순차 또는
    │                                    │  병렬 가능
    ├─ @developer ───────────────────────┤
    │                                    │
    ├─ @tester ──────────────────────────┤
    │                                    │
    ├─ @security ────────────────────────┤
    │                                    │
    └─ @reviewer ────────────────────────┘
```

---

## 작업 완료 조건

모든 에이전트 공통:

- [ ] 내 직무 범위 작업 완료
- [ ] 산출물 생성/업데이트
- [ ] 검증 통과
- [ ] 문서 동기화
- [ ] 핸드오프 준비 완료

---

## 품질 수렴 루프

> 100% 달성까지 반복

```
측정 → 분석 → 개선 → 재측정 → ... → 100% 수렴
```

**측정 도구 (3단계 필수)**:
1. `node .github/scripts/sdd-verify.js` - SDD 구조 검증
2. `node .github/scripts/check-docs.js --all` - 문서 검증
3. `node .github/scripts/check-patterns.js [파일]` - 코드 패턴 검증

**수렴 판정**:
| 점수 | 상태 | 조치 |
|------|------|------|
| 100% | ✅ 완료 | 핸드오프 |
| 95-99% | ⚠️ 경미 | 경고 검토 후 진행 가능 |
| 90-94% | 🔶 개선 필요 | Gap 분석 → 개선 |
| <90% | 🔴 즉시 조치 | 반복 수행 |

**참조**: `prompts/core/quality-loop.prompt.md`

---

## Changelog

| 날짜 | 변경 내용 |
|------|----------|
| 2026-02-06 | 에이전트 표시 프로토콜 추가 (시작/전환 시 표시 필수) |
| 2026-02-06 | 기존 코드 참조 규칙 강화 (일관성 검증 체크리스트) |
| 2026-02-06 | 3단계 검증 도구 명시 (sdd-verify, check-docs, check-patterns) |
| 2026-02-05 | 초기 버전 - 에이전트 공통 워크플로우 정의 |
