# 🔍 Phase 1.2.1 API 호출 패턴 분석 결과

**분석 일시**: 2025-01-20  
**분석 대상**: 현재 API 호출 구조 전체  
**브랜치**: refactor/v1  

---

## 📊 현재 API 호출 구조 현황

### ✅ 기존 API 클라이언트 구조

#### **1. utils/apiClient.ts - 중앙화된 API 클라이언트**
```typescript
// 현재 구조
├── request() - 기본 HTTP 요청 함수
├── fileApi - 파일 관련 API 객체
│   ├── create()
│   ├── read() 
│   ├── update()
│   ├── delete()
│   ├── rename()
│   └── createFolder()
└── filesApi - 파일 목록 관련 API 객체
    ├── getFileTree()
    └── getFiles()
```

#### **2. API 호출 분포 현황**
| 컴포넌트/Hook | 사용하는 API | 호출 빈도 |
|---------------|-------------|-----------|
| **app/wiki/page.tsx** | fileApi.create, fileApi.createFolder, filesApi.getFileTree, fileApi.rename, fileApi.read, fileApi.update, fileApi.delete | **9회** (가장 많음) |
| **hooks/useFileOperations.ts** | filesApi.getFileTree, fileApi.read, fileApi.update, fileApi.create, fileApi.createFolder, fileApi.delete | **6회** |

### 🔍 **발견된 API 호출 패턴**

#### **패턴 1: 직접 API 호출 (현재 주류)**
```typescript
// 예시: app/wiki/page.tsx
const response = await fileApi.create(fullPath, content);
const response = await filesApi.getFileTree();
const response = await fileApi.read(path);
```

#### **패턴 2: 에러 처리 패턴**
```typescript
// 공통 패턴: safeAsync 래퍼 사용
const [response, error] = await safeAsync(() => fileApi.read(path));
if (error) {
  logger.error('파일 읽기 실패', { path, error });
  return;
}
```

#### **패턴 3: 응답 처리 패턴**
```typescript
// 공통 패턴: success 체크 후 데이터 사용
if (response.success) {
  // 성공 처리
  setContent(response.data);
} else {
  // 에러 처리
  showError('파일 읽기 실패', response.error);
}
```

---

## 🎯 추상화 대상 식별

### **높은 우선순위 (즉시 추상화 필요)**

#### **1. 파일 CRUD 작업**
- **fileApi.create()** - 새 파일 생성
- **fileApi.read()** - 파일 내용 읽기  
- **fileApi.update()** - 파일 내용 수정
- **fileApi.delete()** - 파일 삭제
- **사용 빈도**: 총 15회 (가장 높음)

#### **2. 폴더 관리 작업**
- **fileApi.createFolder()** - 새 폴더 생성
- **fileApi.rename()** - 파일/폴더 이름 변경
- **사용 빈도**: 총 3회

#### **3. 파일 트리 조회**
- **filesApi.getFileTree()** - 전체 파일 트리 조회
- **filesApi.getFiles()** - 특정 경로 파일 목록
- **사용 빈도**: 총 2회

### **중간 우선순위 (점진적 추상화)**

#### **4. 에러 처리 및 로깅**
- 현재: 각 컴포넌트에서 개별 처리
- 목표: 서비스 레이어에서 일관된 처리

#### **5. 로딩 상태 관리**
- 현재: 컴포넌트별 개별 관리
- 목표: 서비스 레이어에서 중앙화

---

## 🔧 기존 구조의 장단점 분석

### ✅ **현재 구조의 장점**
1. **타입 안전성**: 잘 정의된 인터페이스
2. **일관된 응답 형식**: ApiResponse<T> 사용
3. **에러 처리**: 구조화된 에러 응답
4. **재사용성**: fileApi, filesApi 객체 형태

### ⚠️ **현재 구조의 문제점**

#### **1. 추상화 레벨 부족**
```typescript
// 문제: 컴포넌트에서 직접 API 세부사항 관리
const response = await fileApi.create(fullPath, content);
if (response.success) {
  setTreeData(response.data);
  showSuccess('파일 생성 성공');
} else {
  showError('파일 생성 실패', response.error);
}
```

#### **2. 중복 로직**
- 에러 처리 로직이 각 컴포넌트에 반복됨
- 로딩 상태 관리가 각 컴포넌트에 분산됨
- 성공/실패 알림 로직이 중복됨

#### **3. 비즈니스 로직 분산**
- 파일 생성 후 트리 새로고침 로직
- 파일 삭제 후 선택 상태 초기화 로직
- 파일 이름 변경 후 상태 동기화 로직

#### **4. 테스트 어려움**
- API 호출이 컴포넌트와 강결합
- 비즈니스 로직과 UI 로직이 혼재

---

## 🎯 추상화 전략

### **레이어 1: 기본 HTTP 클라이언트**
```typescript
// 현재: utils/apiClient.ts
// 역할: HTTP 요청/응답, 에러 처리
// 상태: ✅ 이미 잘 구현됨
```

### **🎯 레이어 2: 도메인 서비스 (새로 구축)**
```typescript
// 목표: services/fileSystemService.ts
// 역할: 파일 시스템 비즈니스 로직
// 예시:
class FileSystemService {
  async createFile(path: string, content: string) {
    // 1. API 호출
    // 2. 결과 검증
    // 3. 상태 동기화
    // 4. 이벤트 발행
  }
}
```

### **🎯 레이어 3: 상태 관리 훅 (개선)**
```typescript
// 목표: hooks/useFileSystem.ts
// 역할: React 상태와 서비스 연결
// 예시:
const useFileSystem = () => {
  const service = useFileSystemService();
  // 로딩 상태, 에러 상태 통합 관리
}
```

---

## 📋 추상화 우선순위

### **Phase 1: 핵심 파일 작업 (1-2일)**
1. **FileSystemService** 생성
   - createFile, readFile, updateFile, deleteFile
   - createFolder, renameItem
   - 통합 에러 처리 및 로깅

2. **FileTreeService** 생성
   - getFileTree, refreshTree
   - 트리 상태 관리 및 캐싱

### **Phase 2: 상태 관리 통합 (1-2일)**
1. **useFileSystem** 훅 개선
   - 로딩 상태 중앙화
   - 에러 상태 중앙화
   - 이벤트 기반 상태 동기화

2. **기존 컴포넌트 점진적 적용**
   - app/wiki/page.tsx 우선
   - hooks/useFileOperations.ts 다음

---

## 🔍 API 엔드포인트 분석

### **현재 활용 중인 API 엔드포인트**
```
POST /api/file - 파일 CRUD 작업 (action 기반)
├── action: 'create' - 파일 생성
├── action: 'read' - 파일 읽기
├── action: 'update' - 파일 수정
├── action: 'delete' - 파일 삭제
└── action: 'rename' - 파일명 변경

GET /api/files - 파일 트리 조회
└── ?path=... - 특정 경로 조회 (옵션)

GET /api/watch - 실시간 파일 변경 감지 (SSE)
```

### **API 응답 형식 (표준화됨)**
```typescript
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: string;
  message?: string;
}
```

---

## ✅ 분석 결론

### **현재 상태 평가**
- ✅ **기본 HTTP 클라이언트**: 잘 구현됨
- ⚠️ **도메인 서비스 레이어**: 누락됨 (가장 큰 개선점)
- ⚠️ **상태 관리**: 분산되어 있음
- ✅ **타입 시스템**: 잘 정의됨 (Phase 1.1 완료)

### **다음 단계 권고**
1. **🎯 즉시 시작**: services/ 폴더 구조 생성
2. **우선 구현**: FileSystemService, FileTreeService
3. **점진적 적용**: 기존 컴포넌트 하나씩 마이그레이션

이 분석을 바탕으로 **Phase 1.2.2 API 레이어 인터페이스 설계**를 시작할 준비가 완료되었습니다.